<!DOCTYPE html>
<html lang="zh">
    <head>
        
        


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="站点描述">
<title>
【基础】多数据源建设与动态路由(数据源的原理与动态数据源使用) - 博客
</title>



        
        <meta property="og:title" content="【基础】多数据源建设与动态路由(数据源的原理与动态数据源使用) - 博客" />
<meta property="og:type" content="website" />
<meta property="og:description" content="【基础】多数据源建设与动态路由(数据源的原理与动态数据源使用)"/>
<meta property="og:url" content="https://huangruiying.github.io/%E6%9E%B6%E6%9E%84%E5%8F%8A%E8%AE%BE%E8%AE%A1/%E8%AF%BE%E9%A2%98%E7%A0%94%E7%A9%B6/1.%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84/%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90%E4%B8%8E%E5%88%86%E7%89%87/%E5%9F%BA%E7%A1%80%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%BB%BA%E8%AE%BE%E4%B8%8E%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E5%8E%9F%E7%90%86%E4%B8%8E%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90%E4%BD%BF%E7%94%A8/"/>
<meta property="og:site_name" content="博客"/>




<meta property="og:image" content="https://huangruiying.github.io/home/profile.jpg"/>




        
<link rel="shortcut icon" href="/img/fav.ico">


        





<link rel="stylesheet" href="/css/main.min.dd3261b90e17cd2e5208587affc019817808ed59c99ecc51d4593170ce72c29d.css" integrity="sha256-3TJhuQ4XzS5SCFh6/8AZgXgI7VnJnsxR1FkxcM5ywp0=" crossorigin="anonymous" media="screen">





        
        
        
        
    </head>
    <body>
        <section id="top" class="section">
            
            <div class="container hero  fade-in one ">
                
                <h1 class="bold-title is-1">【基础】多数据源建设与动态路由(数据源的原理与动态数据源使用)</h1>
                
            </div>
            
            <div class="section  fade-in two ">
                

<div class="container">
    <hr>
    <nav class="navbar" role="navigation" aria-label="main navigation">
        
        <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false" >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
        <div class="navbar-menu " id="navMenu">
            
            
            
            
            <a class="navbar-item" href="/blog/">
                
                博客
                
            </a>
            
            
            
            <a class="navbar-item" href="/tags/">
                
                标签
                
            </a>
            
            
            
            <a class="navbar-item" href="/categories/">
                
                类目
                
            </a>
            
            
            
            <a class="navbar-item" href="/">
                
                主页
                
            </a>
            
            
            
        </div>
    </nav>
    <hr>
</div>




                
    <div class="container markdown top-pad">
        
<h2 id="先了解数据源的定义" class="anchor-link"><a href="#%e5%85%88%e4%ba%86%e8%a7%a3%e6%95%b0%e6%8d%ae%e6%ba%90%e7%9a%84%e5%ae%9a%e4%b9%89">先了解数据源的定义</a></h2>
<p>数据源，就是一个获取数据库连接的工厂类，是java官方的定义，所有数据库连接池有遵循该标准</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#719e07">package</span> javax.sql<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> java.sql.Connection<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> java.sql.SQLException<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> java.sql.Wrapper<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">public</span> <span style="color:#268bd2">interface</span> <span style="color:#268bd2">DataSource</span> <span style="color:#268bd2">extends</span> CommonDataSource<span style="color:#719e07">,</span> Wrapper <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>  Connection <span style="color:#268bd2">getConnection</span><span style="color:#719e07">()</span> <span style="color:#268bd2">throws</span> SQLException<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>  Connection <span style="color:#268bd2">getConnection</span><span style="color:#719e07">(</span>String username<span style="color:#719e07">,</span> String password<span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">throws</span> SQLException<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">}</span>
</span></span></code></pre></div>
<h2 id="数据源的创建" class="anchor-link"><a href="#%e6%95%b0%e6%8d%ae%e6%ba%90%e7%9a%84%e5%88%9b%e5%bb%ba">数据源的创建</a></h2>
<p>我们在配置文件中，维护好数据库地址、驱动类等信息，并在代码中创建DataSource对象，读取到配置文件中的配置信息。
自创建DataSource对象</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">DataSourceConfig</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Bean</span><span style="color:#719e07">(</span>name <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;testDruidDataSource&#34;</span><span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> DataSource <span style="color:#268bd2">dataSource</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        DruidDataSource ds <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> DruidDataSource<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setDriverClassName<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>getDriverClassName<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        DRIVER_CLASSNAME <span style="color:#719e07">=</span> dataSourceParam<span style="color:#719e07">.</span>getDriverClassName<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setUrl<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>getUrl<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setUsername<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>getUsername<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setPassword<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>getPassword<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setInitialSize<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>getInitialSize<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setMinIdle<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>getMinIdle<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setMaxActive<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>getMaxActive<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setMinEvictableIdleTimeMillis<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>getMinEvictableIdleTimeMillis<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setValidationQuery<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>getValidationQuery<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setTestWhileIdle<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>isTestWhileIdle<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setTestOnBorrow<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>isTestOnBorrow<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setTestOnReturn<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>isTestOnReturn<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setPoolPreparedStatements<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>isPoolPreparedStatements<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setMaxPoolPreparedStatementPerConnectionSize<span style="color:#719e07">(</span>dataSourceParam<span style="color:#719e07">.</span>getMaxPoolPreparedStatementPerConnectionSize<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ds<span style="color:#719e07">.</span>setMaxWait<span style="color:#719e07">(</span><span style="color:#2aa198">60000</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        log<span style="color:#719e07">.</span>info<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;【&#34;</span> <span style="color:#719e07">+</span> <span style="color:#719e07">this</span><span style="color:#719e07">.</span>getClass<span style="color:#719e07">().</span>getName<span style="color:#719e07">()</span> <span style="color:#719e07">+</span> <span style="color:#2aa198">&#34;】数据源初始化成功&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> ds<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">}</span>
</span></span></code></pre></div><p>或者我们也可以交给Spring自动生成DataSource对象。</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#268bd2">@ConditionalOnClass</span><span style="color:#719e07">(</span>HikariDataSource<span style="color:#719e07">.</span>class<span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">@ConditionalOnMissingBean</span><span style="color:#719e07">(</span>DataSource<span style="color:#719e07">.</span>class<span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">@ConditionalOnProperty</span><span style="color:#719e07">(</span>name <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;spring.datasource.type&#34;</span><span style="color:#719e07">,</span> havingValue <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;com.zaxxer.hikari.HikariDataSource&#34;</span><span style="color:#719e07">,</span> matchIfMissing <span style="color:#719e07">=</span> <span style="color:#cb4b16">true</span><span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">static</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">Hikari</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@ConfigurationProperties</span><span style="color:#719e07">(</span>prefix <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;spring.datasource.hikari&#34;</span><span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> HikariDataSource <span style="color:#268bd2">dataSource</span><span style="color:#719e07">(</span>DataSourceProperties properties<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        HikariDataSource dataSource <span style="color:#719e07">=</span> createDataSource<span style="color:#719e07">(</span>properties<span style="color:#719e07">,</span>
</span></span><span style="display:flex;"><span>                HikariDataSource<span style="color:#719e07">.</span>class<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>StringUtils<span style="color:#719e07">.</span>hasText<span style="color:#719e07">(</span>properties<span style="color:#719e07">.</span>getName<span style="color:#719e07">()))</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            dataSource<span style="color:#719e07">.</span>setPoolName<span style="color:#719e07">(</span>properties<span style="color:#719e07">.</span>getName<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> dataSource<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">@ConfigurationProperties</span><span style="color:#719e07">(</span>prefix <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;spring.datasource&#34;</span><span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">DataSourceProperties</span> <span style="color:#268bd2">implements</span> BeanClassLoaderAware<span style="color:#719e07">,</span> InitializingBean <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">private</span> ClassLoader classLoader<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">}</span>
</span></span></code></pre></div>
<h2 id="动态数据源abstractroutingdatasource是怎么玩的" class="anchor-link"><a href="#%e5%8a%a8%e6%80%81%e6%95%b0%e6%8d%ae%e6%ba%90abstractroutingdatasource%e6%98%af%e6%80%8e%e4%b9%88%e7%8e%a9%e7%9a%84">动态数据源AbstractRoutingDataSource是怎么玩的？</a></h2>
<p>现在，我们知道了什么是数据源，他的作用是什么。那么我们程序如果想连接多个数据源，除了创建多个数据源对象之外，还需要做什么呢？
我们看下spring的AbstractRoutingDataSource源码</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#719e07">package</span> org.springframework.jdbc.datasource.lookup<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">/**
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"> * 数据源初始化到 targetDataSources defaultTargetDataSource
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"> * 再根据自定义规则转存到 resolvedDataSources resolvedDefaultDataSource
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"> * 使用数据源时，优先在 resolvedDataSources 获取，若获取不到则去 resolvedDefaultDataSource 获取
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">public</span> <span style="color:#268bd2">abstract</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">AbstractRoutingDataSource</span> <span style="color:#268bd2">extends</span> AbstractDataSource <span style="color:#268bd2">implements</span> InitializingBean <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">private</span> Map<span style="color:#719e07">&lt;</span>Object<span style="color:#719e07">,</span> Object<span style="color:#719e07">&gt;</span> targetDataSources<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">private</span> Object defaultTargetDataSource<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">private</span> <span style="color:#dc322f">boolean</span> lenientFallback <span style="color:#719e07">=</span> <span style="color:#cb4b16">true</span><span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">private</span> DataSourceLookup dataSourceLookup <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> JndiDataSourceLookup<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">private</span> Map<span style="color:#719e07">&lt;</span>Object<span style="color:#719e07">,</span> DataSource<span style="color:#719e07">&gt;</span> resolvedDataSources<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">private</span> DataSource resolvedDefaultDataSource<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">/**
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     * 初始化所有数据源
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     *
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     * @param targetDataSources
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">setTargetDataSources</span><span style="color:#719e07">(</span>Map<span style="color:#719e07">&lt;</span>Object<span style="color:#719e07">,</span> Object<span style="color:#719e07">&gt;</span> targetDataSources<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">this</span><span style="color:#719e07">.</span>targetDataSources <span style="color:#719e07">=</span> targetDataSources<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">/**
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     * 默认使用的数据源
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     * @param defaultTargetDataSource
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">setDefaultTargetDataSource</span><span style="color:#719e07">(</span>Object defaultTargetDataSource<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">this</span><span style="color:#719e07">.</span>defaultTargetDataSource <span style="color:#719e07">=</span> defaultTargetDataSource<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">setLenientFallback</span><span style="color:#719e07">(</span><span style="color:#dc322f">boolean</span> lenientFallback<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">this</span><span style="color:#719e07">.</span>lenientFallback <span style="color:#719e07">=</span> lenientFallback<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">setDataSourceLookup</span><span style="color:#719e07">(</span><span style="color:#268bd2">@Nullable</span> DataSourceLookup dataSourceLookup<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">this</span><span style="color:#719e07">.</span>dataSourceLookup <span style="color:#719e07">=</span> <span style="color:#719e07">(</span>dataSourceLookup <span style="color:#719e07">!=</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">?</span> dataSourceLookup <span style="color:#719e07">:</span> <span style="color:#719e07">new</span> JndiDataSourceLookup<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">/**
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     * targetDataSources 存到 resolvedDataSources
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     * defaultTargetDataSource 存到 resolvedDefaultDataSource
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">afterPropertiesSet</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> <span style="color:#719e07">(</span><span style="color:#719e07">this</span><span style="color:#719e07">.</span>targetDataSources <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">throw</span> <span style="color:#719e07">new</span> IllegalArgumentException<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Property &#39;targetDataSources&#39; is required&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">this</span><span style="color:#719e07">.</span>resolvedDataSources <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> HashMap<span style="color:#719e07">&lt;&gt;(</span><span style="color:#719e07">this</span><span style="color:#719e07">.</span>targetDataSources<span style="color:#719e07">.</span>size<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">this</span><span style="color:#719e07">.</span>targetDataSources<span style="color:#719e07">.</span>forEach<span style="color:#719e07">((</span>key<span style="color:#719e07">,</span> value<span style="color:#719e07">)</span> <span style="color:#719e07">-&gt;</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            Object lookupKey <span style="color:#719e07">=</span> resolveSpecifiedLookupKey<span style="color:#719e07">(</span>key<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>            DataSource dataSource <span style="color:#719e07">=</span> resolveSpecifiedDataSource<span style="color:#719e07">(</span>value<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">this</span><span style="color:#719e07">.</span>resolvedDataSources<span style="color:#719e07">.</span>put<span style="color:#719e07">(</span>lookupKey<span style="color:#719e07">,</span> dataSource<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">});</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> <span style="color:#719e07">(</span><span style="color:#719e07">this</span><span style="color:#719e07">.</span>defaultTargetDataSource <span style="color:#719e07">!=</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">this</span><span style="color:#719e07">.</span>resolvedDefaultDataSource <span style="color:#719e07">=</span> resolveSpecifiedDataSource<span style="color:#719e07">(</span><span style="color:#719e07">this</span><span style="color:#719e07">.</span>defaultTargetDataSource<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">protected</span> Object <span style="color:#268bd2">resolveSpecifiedLookupKey</span><span style="color:#719e07">(</span>Object lookupKey<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> lookupKey<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">protected</span> DataSource <span style="color:#268bd2">resolveSpecifiedDataSource</span><span style="color:#719e07">(</span>Object dataSource<span style="color:#719e07">)</span> <span style="color:#268bd2">throws</span> IllegalArgumentException <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>dataSource <span style="color:#719e07">instanceof</span> DataSource<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">return</span> <span style="color:#719e07">(</span>DataSource<span style="color:#719e07">)</span> dataSource<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span> <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>dataSource <span style="color:#719e07">instanceof</span> String<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">return</span> <span style="color:#719e07">this</span><span style="color:#719e07">.</span>dataSourceLookup<span style="color:#719e07">.</span>getDataSource<span style="color:#719e07">((</span>String<span style="color:#719e07">)</span> dataSource<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span> <span style="color:#719e07">else</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">throw</span> <span style="color:#719e07">new</span> IllegalArgumentException<span style="color:#719e07">(</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#2aa198">&#34;Illegal data source value - only [javax.sql.DataSource] and String supported: &#34;</span> <span style="color:#719e07">+</span> dataSource<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> Connection <span style="color:#268bd2">getConnection</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> determineTargetDataSource<span style="color:#719e07">().</span>getConnection<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> Connection <span style="color:#268bd2">getConnection</span><span style="color:#719e07">(</span>String username<span style="color:#719e07">,</span> String password<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> determineTargetDataSource<span style="color:#719e07">().</span>getConnection<span style="color:#719e07">(</span>username<span style="color:#719e07">,</span> password<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@SuppressWarnings</span><span style="color:#719e07">(</span><span style="color:#2aa198">&#34;unchecked&#34;</span><span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> <span style="color:#719e07">&lt;</span>T<span style="color:#719e07">&gt;</span> T <span style="color:#268bd2">unwrap</span><span style="color:#719e07">(</span>Class<span style="color:#719e07">&lt;</span>T<span style="color:#719e07">&gt;</span> iface<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>iface<span style="color:#719e07">.</span>isInstance<span style="color:#719e07">(</span><span style="color:#719e07">this</span><span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">return</span> <span style="color:#719e07">(</span>T<span style="color:#719e07">)</span> <span style="color:#719e07">this</span><span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> determineTargetDataSource<span style="color:#719e07">().</span>unwrap<span style="color:#719e07">(</span>iface<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> <span style="color:#dc322f">boolean</span> <span style="color:#268bd2">isWrapperFor</span><span style="color:#719e07">(</span>Class<span style="color:#719e07">&lt;?&gt;</span> iface<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> <span style="color:#719e07">(</span>iface<span style="color:#719e07">.</span>isInstance<span style="color:#719e07">(</span><span style="color:#719e07">this</span><span style="color:#719e07">)</span> <span style="color:#719e07">||</span> determineTargetDataSource<span style="color:#719e07">().</span>isWrapperFor<span style="color:#719e07">(</span>iface<span style="color:#719e07">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">/**
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     * 动态获取数据源 
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">protected</span> DataSource <span style="color:#268bd2">determineTargetDataSource</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        Assert<span style="color:#719e07">.</span>notNull<span style="color:#719e07">(</span><span style="color:#719e07">this</span><span style="color:#719e07">.</span>resolvedDataSources<span style="color:#719e07">,</span> <span style="color:#2aa198">&#34;DataSource router not initialized&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#586e75">// 动态获取数据源
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>        Object lookupKey <span style="color:#719e07">=</span> determineCurrentLookupKey<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>        DataSource dataSource <span style="color:#719e07">=</span> <span style="color:#719e07">this</span><span style="color:#719e07">.</span>resolvedDataSources<span style="color:#719e07">.</span>get<span style="color:#719e07">(</span>lookupKey<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>dataSource <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">&amp;&amp;</span> <span style="color:#719e07">(</span><span style="color:#719e07">this</span><span style="color:#719e07">.</span>lenientFallback <span style="color:#719e07">||</span> lookupKey <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            dataSource <span style="color:#719e07">=</span> <span style="color:#719e07">this</span><span style="color:#719e07">.</span>resolvedDefaultDataSource<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>dataSource <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">throw</span> <span style="color:#719e07">new</span> IllegalStateException<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Cannot determine target DataSource for lookup key [&#34;</span> <span style="color:#719e07">+</span> lookupKey <span style="color:#719e07">+</span> <span style="color:#2aa198">&#34;]&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> dataSource<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">/**
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     * 通过这个key，获取正确的的数据源
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">protected</span> <span style="color:#268bd2">abstract</span> Object <span style="color:#268bd2">determineCurrentLookupKey</span><span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">}</span>
</span></span></code></pre></div><p>在代码中发现，可以创建多个DataSource,写入AbstractRoutingDataSource中，并且我们可以通过 determineCurrentLookupKey 来选择自己想要的数据源
在执行查询时，会调用getConnection()进行获取连接，所以我们只需要实现 AbstractRoutingDataSource 即可。</p>

<h2 id="just-do-it" class="anchor-link"><a href="#just-do-it">just do it</a></h2>
<p>在使用时，我们的步骤为：1。创建动态数据源；2。将数据源填充到SqlSessionFactory</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#719e07">package</span> org.huangry.colorful.mds.config.datasource<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> com.zaxxer.hikari.HikariConfig<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> com.zaxxer.hikari.HikariDataSource<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.huangry.colorful.mds.common.util.RequestUtil<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.huangry.colorful.mds.common.util.SpringUtil<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.springframework.context.annotation.Bean<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.springframework.context.annotation.Primary<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.springframework.stereotype.Component<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> java.util.HashMap<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> java.util.Map<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">@Component</span><span style="color:#719e07">(</span>value <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;dynamicDataSource&#34;</span><span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">@Primary</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">DynamicDataSource</span> <span style="color:#268bd2">extends</span> AbstractRoutingDataSource <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">protected</span> Object <span style="color:#268bd2">determineCurrentLookupKey</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#586e75">// todo 在这里获取请求头携带的流量标识
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span> RequestUtil<span style="color:#719e07">.</span>getHeader<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;head&#34;</span><span style="color:#719e07">,</span> RequestUtil<span style="color:#719e07">.</span>getRequest<span style="color:#719e07">(),</span> <span style="color:#2aa198">&#34;ds1&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">afterPropertiesSet</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#586e75">// 初始化多数据源
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>        Map<span style="color:#719e07">&lt;</span>Object<span style="color:#719e07">,</span> Object<span style="color:#719e07">&gt;</span> datasources <span style="color:#719e07">=</span> buildDataSources<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#586e75">// 初始化动态数据源
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>        setTargetDataSources<span style="color:#719e07">(</span>datasources<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#268bd2">super</span><span style="color:#719e07">.</span>afterPropertiesSet<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">private</span> Map<span style="color:#719e07">&lt;</span>Object<span style="color:#719e07">,</span> Object<span style="color:#719e07">&gt;</span> <span style="color:#268bd2">buildDataSources</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#719e07">&lt;</span>Object<span style="color:#719e07">,</span> Object<span style="color:#719e07">&gt;</span> dataSourceMap <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> HashMap<span style="color:#719e07">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        dataSourceMap<span style="color:#719e07">.</span>put<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;ds1&#34;</span><span style="color:#719e07">,</span> SpringUtil<span style="color:#719e07">.</span>getBean<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;dataSource1&#34;</span><span style="color:#719e07">,</span> HikariDataSource<span style="color:#719e07">.</span>class<span style="color:#719e07">));</span>
</span></span><span style="display:flex;"><span>        dataSourceMap<span style="color:#719e07">.</span>put<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;ds2&#34;</span><span style="color:#719e07">,</span> SpringUtil<span style="color:#719e07">.</span>getBean<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;dataSource2&#34;</span><span style="color:#719e07">,</span> HikariDataSource<span style="color:#719e07">.</span>class<span style="color:#719e07">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> dataSourceMap<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Bean</span><span style="color:#719e07">(</span><span style="color:#2aa198">&#34;dataSource1&#34;</span><span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> HikariDataSource <span style="color:#268bd2">dataSource1</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        HikariConfig hikariConfig <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> HikariConfig<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setDriverClassName<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;com.mysql.cj.jdbc.Driver&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setJdbcUrl<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;jdbc:mysql://xxxxxx:3306/xxx?characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setUsername<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;111111&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setPassword<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;111111&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setMinimumIdle<span style="color:#719e07">(</span><span style="color:#2aa198">2</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setMaximumPoolSize<span style="color:#719e07">(</span><span style="color:#2aa198">5</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setConnectionTimeout<span style="color:#719e07">(</span><span style="color:#2aa198">5000</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setIdleTimeout<span style="color:#719e07">(</span><span style="color:#2aa198">30000</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setMaxLifetime<span style="color:#719e07">(</span><span style="color:#2aa198">60000</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setConnectionTestQuery<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;SELECT 1&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setAutoCommit<span style="color:#719e07">(</span><span style="color:#cb4b16">true</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setMinimumIdle<span style="color:#719e07">(</span><span style="color:#2aa198">2</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setMaximumPoolSize<span style="color:#719e07">(</span><span style="color:#2aa198">5</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setConnectionTimeout<span style="color:#719e07">(</span><span style="color:#2aa198">5000</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setIdleTimeout<span style="color:#719e07">(</span><span style="color:#2aa198">30000</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setMaxLifetime<span style="color:#719e07">(</span><span style="color:#2aa198">60000</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setConnectionTestQuery<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;SELECT 1&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setAutoCommit<span style="color:#719e07">(</span><span style="color:#cb4b16">true</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> <span style="color:#719e07">new</span> HikariDataSource<span style="color:#719e07">(</span>hikariConfig<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Bean</span><span style="color:#719e07">(</span><span style="color:#2aa198">&#34;dataSource2&#34;</span><span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// @ConfigurationProperties(prefix = &#34;spring.datasource.hikari.ds2&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>    <span style="color:#268bd2">public</span> HikariDataSource <span style="color:#268bd2">dataSource2</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        HikariConfig hikariConfig <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> HikariConfig<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setDriverClassName<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;com.mysql.cj.jdbc.Driver&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setJdbcUrl<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;jdbc:mysql://xxxxxx:3306/xxx?characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setUsername<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;222222&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setPassword<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;222222&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setMinimumIdle<span style="color:#719e07">(</span><span style="color:#2aa198">2</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setMaximumPoolSize<span style="color:#719e07">(</span><span style="color:#2aa198">5</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setConnectionTimeout<span style="color:#719e07">(</span><span style="color:#2aa198">5000</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setIdleTimeout<span style="color:#719e07">(</span><span style="color:#2aa198">30000</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setMaxLifetime<span style="color:#719e07">(</span><span style="color:#2aa198">60000</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setConnectionTestQuery<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;SELECT 1&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setAutoCommit<span style="color:#719e07">(</span><span style="color:#cb4b16">true</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setMinimumIdle<span style="color:#719e07">(</span><span style="color:#2aa198">2</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setMaximumPoolSize<span style="color:#719e07">(</span><span style="color:#2aa198">5</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setConnectionTimeout<span style="color:#719e07">(</span><span style="color:#2aa198">5000</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setIdleTimeout<span style="color:#719e07">(</span><span style="color:#2aa198">30000</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setMaxLifetime<span style="color:#719e07">(</span><span style="color:#2aa198">60000</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setConnectionTestQuery<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;SELECT 1&#34;</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        hikariConfig<span style="color:#719e07">.</span>setAutoCommit<span style="color:#719e07">(</span><span style="color:#cb4b16">true</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> <span style="color:#719e07">new</span> HikariDataSource<span style="color:#719e07">(</span>hikariConfig<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#719e07">package</span> org.huangry.colorful.mds.config<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> com.baomidou.mybatisplus.annotation.FieldStrategy<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> com.baomidou.mybatisplus.core.MybatisConfiguration<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> com.baomidou.mybatisplus.core.config.GlobalConfig<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> com.baomidou.mybatisplus.core.toolkit.GlobalConfigUtils<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> com.baomidou.mybatisplus.extension.MybatisMapWrapperFactory<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> com.baomidou.mybatisplus.extension.plugins.OptimisticLockerInterceptor<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> com.baomidou.mybatisplus.extension.plugins.PaginationInterceptor<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> lombok.extern.slf4j.Slf4j<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.apache.ibatis.plugin.Interceptor<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.apache.ibatis.session.SqlSessionFactory<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.apache.ibatis.type.JdbcType<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.huangry.colorful.mds.config.mybatisplus.override.CustomInjector<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.mybatis.spring.annotation.MapperScan<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.springframework.context.annotation.Bean<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.springframework.context.annotation.Configuration<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> org.springframework.transaction.annotation.EnableTransactionManagement<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> javax.annotation.Resource<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">import</span> javax.sql.DataSource<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#586e75">/**
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"> * SqlSessionFactory
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">@EnableTransactionManagement</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">@MapperScan</span><span style="color:#719e07">(</span>basePackages <span style="color:#719e07">=</span> <span style="color:#719e07">{</span><span style="color:#2aa198">&#34;org.huangry.colorful.mds.dao&#34;</span><span style="color:#719e07">})</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">HikariDataSourceConfig</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> <span style="color:#268bd2">static</span> <span style="color:#268bd2">final</span> String MODEL_PACKAGES <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;org.huangry.colorful.mds.common.table&#34;</span><span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> <span style="color:#268bd2">static</span> <span style="color:#268bd2">final</span> String MAPPING_LOCATION <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;classpath:mapper/*Mapper.xml&#34;</span><span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Bean</span><span style="color:#719e07">(</span><span style="color:#2aa198">&#34;sqlSessionFactory&#34;</span><span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> SqlSessionFactory <span style="color:#268bd2">sqlSessionFactory</span><span style="color:#719e07">(</span>DataSource dataSource<span style="color:#719e07">)</span> <span style="color:#268bd2">throws</span> Exception <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        MybatisSqlSessionFactoryBean sqlSessionFactory <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> MybatisSqlSessionFactoryBean<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>        sqlSessionFactory<span style="color:#719e07">.</span>setPlugins<span style="color:#719e07">(</span><span style="color:#719e07">new</span> Interceptor<span style="color:#719e07">[]{</span>paginationInterceptor<span style="color:#719e07">(),</span> <span style="color:#719e07">new</span> OptimisticLockerInterceptor<span style="color:#719e07">()});</span>
</span></span><span style="display:flex;"><span>        sqlSessionFactory<span style="color:#719e07">.</span>setMapperLocations<span style="color:#719e07">(</span><span style="color:#719e07">new</span> PathMatchingResourcePatternResolver<span style="color:#719e07">().</span>getResources<span style="color:#719e07">(</span>MAPPING_LOCATION<span style="color:#719e07">));</span>
</span></span><span style="display:flex;"><span>        sqlSessionFactory<span style="color:#719e07">.</span>setTypeAliasesPackage<span style="color:#719e07">(</span>MODEL_PACKAGES<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        sqlSessionFactory<span style="color:#719e07">.</span>setDataSource<span style="color:#719e07">(</span>dataSource<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        sqlSessionFactory<span style="color:#719e07">.</span>setGlobalConfig<span style="color:#719e07">(</span>buildGlobalConfig<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        sqlSessionFactory<span style="color:#719e07">.</span>setConfiguration<span style="color:#719e07">(</span>buildMybatisConfiguration<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> sqlSessionFactory<span style="color:#719e07">.</span>getObject<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">}</span>
</span></span></code></pre></div><hr>
<pre tabindex="0"><code>/**
 * 动态数据源使用示例
 * @param args
 */
public static void main(String args[]) {
    // 初始化动态数据源
    AbstractRoutingDataSource dds = new AbstractRoutingDataSource();
    // 默认使用的数据源
    dds.setDefaultTargetDataSource(new DataSource());
    // 所有可用的数据源
    HashMap&lt;String, DataSource&gt; targetDataSources = new HashMap&lt;&gt;();
    targetDataSources.put(&#34;1&#34;, new DataSource());
    targetDataSources.put(&#34;2&#34;, new DataSource());
    dds.setTargetDataSources(targetDataSources);
    
    // Spring初始化bean时，会调用InitializingBean的所有子类的afterPropertiesSet()
    dds.afterPropertiesSet();
    // 确定要使用的数据源
    DataSource datasource = dds.determineTargetDataSource();
    // just do it
    datasource.getConnection().execute(&#34;select xx&#34;);
}
</code></pre>
<h2 id="mybatisplus-动态数据源有什么不同呢ds-dstransactional" class="anchor-link"><a href="#mybatisplus-%e5%8a%a8%e6%80%81%e6%95%b0%e6%8d%ae%e6%ba%90%e6%9c%89%e4%bb%80%e4%b9%88%e4%b8%8d%e5%90%8c%e5%91%a2ds-dstransactional">MybatisPLUS 动态数据源有什么不同呢？@DS @DSTransactional</a></h2>

<h4 id="dynamicdatasourcecontextholder-有啥用-----通过-ds-开启使用-识别使用线程级复用数据源" class="anchor-link"><a href="#dynamicdatasourcecontextholder-%e6%9c%89%e5%95%a5%e7%94%a8-----%e9%80%9a%e8%bf%87-ds-%e5%bc%80%e5%90%af%e4%bd%bf%e7%94%a8-%e8%af%86%e5%88%ab%e4%bd%bf%e7%94%a8%e7%ba%bf%e7%a8%8b%e7%ba%a7%e5%a4%8d%e7%94%a8%e6%95%b0%e6%8d%ae%e6%ba%90">DynamicDataSourceContextHolder 有啥用？     通过 @DS 开启使用； 识别、使用、线程级复用数据源</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">DynamicDataSourceAutoConfiguration</span> <span style="color:#268bd2">implements</span> InitializingBean <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Role</span><span style="color:#719e07">(</span>BeanDefinition<span style="color:#719e07">.</span>ROLE_INFRASTRUCTURE<span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// 当存在配置 spring.datasource.dynamic.seata.aop.enabled=true 时 注册
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>    <span style="color:#268bd2">@ConditionalOnProperty</span><span style="color:#719e07">(</span>prefix <span style="color:#719e07">=</span> DynamicDataSourceProperties<span style="color:#719e07">.</span>PREFIX <span style="color:#719e07">+</span> <span style="color:#2aa198">&#34;.aop&#34;</span><span style="color:#719e07">,</span> name <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;enabled&#34;</span><span style="color:#719e07">,</span> havingValue <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;true&#34;</span><span style="color:#719e07">,</span> matchIfMissing <span style="color:#719e07">=</span> <span style="color:#cb4b16">true</span><span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> Advisor <span style="color:#268bd2">dynamicDatasourceAnnotationAdvisor</span><span style="color:#719e07">(</span>DsProcessor dsProcessor<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        DynamicDatasourceAopProperties aopProperties <span style="color:#719e07">=</span> properties<span style="color:#719e07">.</span>getAop<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>        DynamicDataSourceAnnotationInterceptor interceptor <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> DynamicDataSourceAnnotationInterceptor<span style="color:#719e07">(</span>aopProperties<span style="color:#719e07">.</span>getAllowedPublicOnly<span style="color:#719e07">(),</span> dsProcessor<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        DynamicDataSourceAnnotationAdvisor advisor <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> DynamicDataSourceAnnotationAdvisor<span style="color:#719e07">(</span>interceptor<span style="color:#719e07">,</span> DS<span style="color:#719e07">.</span>class<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        advisor<span style="color:#719e07">.</span>setOrder<span style="color:#719e07">(</span>aopProperties<span style="color:#719e07">.</span>getOrder<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> advisor<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">}</span>
</span></span></code></pre></div>
<h4 id="transactioncontextgetxid-有啥用----------通过-dstransactional-开启使用-一个线程针对一个数据源获取连接时路由到只使用一个连接的逻辑abstractroutingdatasourcegetconnection" class="anchor-link"><a href="#transactioncontextgetxid-%e6%9c%89%e5%95%a5%e7%94%a8----------%e9%80%9a%e8%bf%87-dstransactional-%e5%bc%80%e5%90%af%e4%bd%bf%e7%94%a8-%e4%b8%80%e4%b8%aa%e7%ba%bf%e7%a8%8b%e9%92%88%e5%af%b9%e4%b8%80%e4%b8%aa%e6%95%b0%e6%8d%ae%e6%ba%90%e8%8e%b7%e5%8f%96%e8%bf%9e%e6%8e%a5%e6%97%b6%e8%b7%af%e7%94%b1%e5%88%b0%e5%8f%aa%e4%bd%bf%e7%94%a8%e4%b8%80%e4%b8%aa%e8%bf%9e%e6%8e%a5%e7%9a%84%e9%80%bb%e8%be%91abstractroutingdatasourcegetconnection">TransactionContext.getXID 有啥用？          通过 @DSTransactional 开启使用； 一个线程针对一个数据源,获取连接时路由到只使用一个连接的逻辑(AbstractRoutingDataSource#getConnection)</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#586e75">// 初始化
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">DynamicDataSourceAutoConfiguration</span> <span style="color:#268bd2">implements</span> InitializingBean <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Role</span><span style="color:#719e07">(</span>BeanDefinition<span style="color:#719e07">.</span>ROLE_INFRASTRUCTURE<span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">// 当存在配置 spring.datasource.dynamic.seata=false 时 注册
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>    <span style="color:#268bd2">@ConditionalOnProperty</span><span style="color:#719e07">(</span>prefix <span style="color:#719e07">=</span> DynamicDataSourceProperties<span style="color:#719e07">.</span>PREFIX<span style="color:#719e07">,</span> name <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;seata&#34;</span><span style="color:#719e07">,</span> havingValue <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;false&#34;</span><span style="color:#719e07">,</span> matchIfMissing <span style="color:#719e07">=</span> <span style="color:#cb4b16">true</span><span style="color:#719e07">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> Advisor <span style="color:#268bd2">dynamicTransactionAdvisor</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        DynamicLocalTransactionInterceptor interceptor <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> DynamicLocalTransactionInterceptor<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#586e75">// 当标记 DSTransactional 注解时，执行LocalTxUtil.startTransaction()
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span> <span style="color:#719e07">new</span> DynamicDataSourceAnnotationAdvisor<span style="color:#719e07">(</span>interceptor<span style="color:#719e07">,</span> DSTransactional<span style="color:#719e07">.</span>class<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#586e75">// 使用
</span></span></span><span style="display:flex;"><span><span style="color:#586e75"></span><span style="color:#268bd2">public</span> <span style="color:#268bd2">abstract</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">AbstractRoutingDataSource</span> <span style="color:#268bd2">extends</span> AbstractDataSource <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> Connection <span style="color:#268bd2">getConnection</span><span style="color:#719e07">()</span> <span style="color:#268bd2">throws</span> SQLException <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        String xid <span style="color:#719e07">=</span> TransactionContext<span style="color:#719e07">.</span>getXID<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>StringUtils<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">(</span>xid<span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">return</span> determineDataSource<span style="color:#719e07">().</span>getConnection<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span> <span style="color:#719e07">else</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            String ds <span style="color:#719e07">=</span> DynamicDataSourceContextHolder<span style="color:#719e07">.</span>peek<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>            ds <span style="color:#719e07">=</span> StringUtils<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">(</span>ds<span style="color:#719e07">)</span> <span style="color:#719e07">?</span> getPrimary<span style="color:#719e07">()</span> <span style="color:#719e07">:</span> ds<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>            ConnectionProxy connection <span style="color:#719e07">=</span> ConnectionFactory<span style="color:#719e07">.</span>getConnection<span style="color:#719e07">(</span>ds<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">return</span> connection <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">?</span> getConnectionProxy<span style="color:#719e07">(</span>ds<span style="color:#719e07">,</span> determineDataSource<span style="color:#719e07">().</span>getConnection<span style="color:#719e07">())</span> <span style="color:#719e07">:</span> connection<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">}</span>
</span></span></code></pre></div>
<h4 id="connectionfactory-有啥用" class="anchor-link"><a href="#connectionfactory-%e6%9c%89%e5%95%a5%e7%94%a8">ConnectionFactory 有啥用？</a></h4>
<p><code>获取连接时，记录当前线程所用的数据源连接代理，事物提交|回滚时销毁该代理;在事物提交|回滚之前，除第一次是创建连接代理外，后续的每次连接获取都是获取的连接代理</code></p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#268bd2">public</span> <span style="color:#268bd2">abstract</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">AbstractRoutingDataSource</span> <span style="color:#268bd2">extends</span> AbstractDataSource <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">private</span> Connection <span style="color:#268bd2">getConnectionProxy</span><span style="color:#719e07">(</span>String ds<span style="color:#719e07">,</span> Connection connection<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        ConnectionProxy connectionProxy <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> ConnectionProxy<span style="color:#719e07">(</span>connection<span style="color:#719e07">,</span> ds<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        ConnectionFactory<span style="color:#719e07">.</span>putConnection<span style="color:#719e07">(</span>ds<span style="color:#719e07">,</span> connectionProxy<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">return</span> connectionProxy<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">/**
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     * 手动提交事务
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> <span style="color:#268bd2">static</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">commit</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">try</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            ConnectionFactory<span style="color:#719e07">.</span>notify<span style="color:#719e07">(</span><span style="color:#cb4b16">true</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span> <span style="color:#719e07">finally</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            log<span style="color:#719e07">.</span>debug<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;dynamic-datasource commit local tx [{}]&#34;</span><span style="color:#719e07">,</span> TransactionContext<span style="color:#719e07">.</span>getXID<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>            TransactionContext<span style="color:#719e07">.</span>remove<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">/**
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     * 手动回滚事务
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> <span style="color:#268bd2">static</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">rollback</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">try</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            ConnectionFactory<span style="color:#719e07">.</span>notify<span style="color:#719e07">(</span><span style="color:#cb4b16">false</span><span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span> <span style="color:#719e07">finally</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            log<span style="color:#719e07">.</span>debug<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;dynamic-datasource rollback local tx [{}]&#34;</span><span style="color:#719e07">,</span> TransactionContext<span style="color:#719e07">.</span>getXID<span style="color:#719e07">());</span>
</span></span><span style="display:flex;"><span>            TransactionContext<span style="color:#719e07">.</span>remove<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#586e75">/**
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     * 销毁
</span></span></span><span style="display:flex;"><span><span style="color:#586e75">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#268bd2">public</span> <span style="color:#268bd2">static</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">notify</span><span style="color:#719e07">(</span>Boolean state<span style="color:#719e07">)</span> <span style="color:#268bd2">throws</span> Exception <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>        Exception exception <span style="color:#719e07">=</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">try</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            Map<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">,</span> ConnectionProxy<span style="color:#719e07">&gt;</span> concurrentHashMap <span style="color:#719e07">=</span> CONNECTION_HOLDER<span style="color:#719e07">.</span>get<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">for</span> <span style="color:#719e07">(</span>ConnectionProxy connectionProxy <span style="color:#719e07">:</span> concurrentHashMap<span style="color:#719e07">.</span>values<span style="color:#719e07">())</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#719e07">try</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>                    connectionProxy<span style="color:#719e07">.</span>notify<span style="color:#719e07">(</span>state<span style="color:#719e07">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#719e07">}</span> <span style="color:#719e07">catch</span> <span style="color:#719e07">(</span>SQLException e<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>                    exception <span style="color:#719e07">=</span> e<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span> <span style="color:#719e07">finally</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>            CONNECTION_HOLDER<span style="color:#719e07">.</span>remove<span style="color:#719e07">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>exception <span style="color:#719e07">!=</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#719e07">throw</span> exception<span style="color:#719e07">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#719e07">}</span>
</span></span><span style="display:flex;"><span><span style="color:#719e07">}</span>
</span></span></code></pre></div>
<h2 id="数据库连接的获取" class="anchor-link"><a href="#%e6%95%b0%e6%8d%ae%e5%ba%93%e8%bf%9e%e6%8e%a5%e7%9a%84%e8%8e%b7%e5%8f%96">数据库连接的获取</a></h2>
<p>@Transactional 开启时，进入方法前先获取，执行过程中使用同一个连接；</p>
<pre tabindex="0"><code>    // 
    @GetMapping(&#34;health&#34;)
    public String health() {
        return JSON.toJSONString(manager.testConnect()) + JSON.toJSONString(manager.testConnect2());
    }
    @Transactional
    BizOrderBill testConnect();

    @Transactional
    BizOrderBill testConnect2();
    
    // 事物开启
    DataSourceTransactionManager#doBegin prepareTransactionalConnection
    
    // 事物提交
    TransactionAspectSupport#invokeWithinTransaction commitTransactionAfterReturning

    // 事物回滚
    TransactionAspectSupport#invokeWithinTransaction completeTransactionAfterThrowing
    
</code></pre><p>@DSTransactional 开启时，mybatis-plus会根据ThreadLocal记录线程所用的连接，并在整个线程中复用该连接；</p>
<pre tabindex="0"><code>    // 启动事物
    LocalTxUtil#startTransaction
    // 事物提交
    LocalTxUtil#commit
    // 事物回滚
    LocalTxUtil#rollback
</code></pre><p>不用事物注解时，每次数据库交互(查询、更新)都会通过数据库连接池获取一个连接；</p>

    </div>
    
    



                
                <div class="container">
    <hr>
</div>
<div class="container has-text-centered top-pad">
    <a href="#top">
        <i class="fa fa-arrow-up"></i>
    </a>
</div>

<div class="container">
    <hr>
</div>

                <div class="section" id="footer">
    <div class="container has-text-centered">
    
        <span class="footer-text">
            
        </span>
    
    </div>
</div>

                
            </div>
        </section>
        
        


<script src="https://huangruiying.github.io/js/bundle.5c23c0437f001a469ca373a465a6f7487203d18e10cdff76d86a60af66d5ee28.js" integrity="sha256-XCPAQ38AGkaco3OkZab3SHID0Y4Qzf922Gpgr2bV7ig="></script>




        
        
        
        
    </body>
</html>
